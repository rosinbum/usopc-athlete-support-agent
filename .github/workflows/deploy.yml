name: Deploy

on:
  push:
    tags: ["v*"]
  workflow_dispatch:
    inputs:
      tag:
        description: "Git tag to deploy (e.g. v1.2.3)"
        required: true
      stage:
        description: "Target stage"
        type: choice
        options:
          - production
        default: production

concurrency:
  group: deploy-${{ github.event_name == 'workflow_dispatch' && inputs.stage || 'staging' }}
  cancel-in-progress: false

permissions:
  id-token: write
  contents: read
  actions: read

jobs:
  # Gate: verify CI passed on the tagged commit before deploying to staging
  ci-check:
    name: Verify CI passed
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Check CI status on tagged commit
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          COMMIT_SHA=$(git rev-parse HEAD)
          echo "Checking CI status for commit $COMMIT_SHA"

          # Wait up to 5 minutes for CI checks to appear and complete
          for i in $(seq 1 30); do
            STATUS=$(gh api "repos/${{ github.repository }}/commits/${COMMIT_SHA}/status" --jq '.state')
            CHECK_RUNS=$(gh api "repos/${{ github.repository }}/commits/${COMMIT_SHA}/check-runs" --jq '[.check_runs[] | select(.name != "Verify CI passed")] | length')

            if [ "$STATUS" = "success" ] && [ "$CHECK_RUNS" -gt 0 ]; then
              echo "CI checks passed."
              exit 0
            elif [ "$STATUS" = "failure" ] || [ "$STATUS" = "error" ]; then
              echo "CI checks failed (status: $STATUS). Aborting deployment."
              exit 1
            fi

            echo "CI status: $STATUS (check runs: $CHECK_RUNS). Waiting 10s... ($i/30)"
            sleep 10
          done

          echo "Timed out waiting for CI checks. Aborting deployment."
          exit 1

  deploy-staging:
    name: Deploy to Staging
    needs: ci-check
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ github.ref }}

      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: 20
          cache: pnpm

      - run: pnpm install --frozen-lockfile

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@7474bc4690e29a8392af63c5b98e7449536d5c3a # v4.3.1
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: us-east-1

      - name: Deploy to staging
        id: deploy
        run: |
          npx sst deploy --stage staging 2>&1 | tee deploy-output.txt
          WEB_URL=$(grep -oP 'webUrl:\s+\K\S+' deploy-output.txt || true)
          if [ -z "$WEB_URL" ]; then
            echo "::warning::Could not extract URLs from SST output. Smoke tests will be skipped."
            echo "SST output:"
            cat deploy-output.txt
          fi
          echo "web_url=$WEB_URL" >> "$GITHUB_OUTPUT"

      - name: Smoke test Web
        if: steps.deploy.outputs.web_url != ''
        run: |
          curl --fail --retry 5 --retry-delay 10 --retry-all-errors \
            "${{ steps.deploy.outputs.web_url }}/api/health"

  deploy-production:
    name: Deploy to Production
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: refs/tags/${{ inputs.tag }}

      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: 20
          cache: pnpm

      - run: pnpm install --frozen-lockfile

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@7474bc4690e29a8392af63c5b98e7449536d5c3a # v4.3.1
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: us-east-1

      - name: Deploy to production
        id: deploy
        run: |
          npx sst deploy --stage production 2>&1 | tee deploy-output.txt
          WEB_URL=$(grep -oP 'webUrl:\s+\K\S+' deploy-output.txt || true)
          if [ -z "$WEB_URL" ]; then
            echo "::warning::Could not extract URLs from SST output. Smoke tests will be skipped."
            echo "SST output:"
            cat deploy-output.txt
          fi
          echo "web_url=$WEB_URL" >> "$GITHUB_OUTPUT"

      - name: Smoke test Web
        if: steps.deploy.outputs.web_url != ''
        run: |
          curl --fail --retry 5 --retry-delay 10 --retry-all-errors \
            "${{ steps.deploy.outputs.web_url }}/api/health"

  rollback-production:
    name: Rollback Production
    needs: deploy-production
    if: failure()
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Find previous production tag
        id: prev-tag
        run: |
          CURRENT_TAG="${{ inputs.tag }}"
          PREV_TAG=$(git tag --sort=-creatordate | grep '^v' | grep -v "^${CURRENT_TAG}$" | head -1)
          if [ -z "$PREV_TAG" ]; then
            echo "No previous tag found â€” cannot rollback"
            exit 1
          fi
          echo "tag=$PREV_TAG" >> "$GITHUB_OUTPUT"
          echo "Rolling back from $CURRENT_TAG to $PREV_TAG"

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: refs/tags/${{ steps.prev-tag.outputs.tag }}

      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: 20
          cache: pnpm

      - run: pnpm install --frozen-lockfile

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@7474bc4690e29a8392af63c5b98e7449536d5c3a # v4.3.1
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: us-east-1

      - name: Redeploy previous tag
        id: deploy
        run: |
          echo "Deploying ${{ steps.prev-tag.outputs.tag }} to production"
          npx sst deploy --stage production 2>&1 | tee deploy-output.txt
          WEB_URL=$(grep -oP 'webUrl:\s+\K\S+' deploy-output.txt || true)
          if [ -z "$WEB_URL" ]; then
            echo "::warning::Could not extract URLs from SST output. Smoke tests will be skipped."
            echo "SST output:"
            cat deploy-output.txt
          fi
          echo "web_url=$WEB_URL" >> "$GITHUB_OUTPUT"

      - name: Smoke test Web
        if: steps.deploy.outputs.web_url != ''
        run: |
          curl --fail --retry 5 --retry-delay 10 --retry-all-errors \
            "${{ steps.deploy.outputs.web_url }}/api/health"
